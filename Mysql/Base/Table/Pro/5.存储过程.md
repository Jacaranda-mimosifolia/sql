### 1. 存储过程 procedure
```
# 存储过程的特性：封装、复用

# 封装
delimiter //  -- 自定义分隔符
create procedure procedure_name([parameter_list])
begin
    ...;
    ...;  # 避免在定义存储过程的语句时出现分隔符问题
end //
delimiter ;

# 调用
call procedure_name([parameter_list]);

# 查看
show create procedure [if exists] procedure_name;
select * from information_schema.routines where routine_schema = 'database_name';

# 删除
drop procedure [if exists] procedure_name;
```

### 2. 变量
```
# 系统变量  @@variable_name
# global    全局变量
# session   会话变量  作用只在当前会话
show [session|global] variables;            # 查看所有的系统变量
show [session|global] variables like '___'; # 模糊匹配
select [session|global] variable_name;      # 查询指定的系统变量

# 用户变量  @var_name

# 局部变量  val_name
show val_name;      -- 查看
select val_name;    -- 使用

# 声明
declare val_name val_type[default expr];

# 赋值
set var_name := expr;  -- set赋值 '='只是临时赋值,':='才是赋值
select col_name into var_name from tab_name;  -- select返回赋值
```

### 3. 传参
```
# 自定义函数：
CREATE PROCEDURE ParameterExample(
    IN in_param INT,
    OUT out_param INT,
    INOUT inout_param INT
)
BEGIN
    -- 读取参数的值
    SELECT in_param;        # 传值
    SELECT out_param;       # 传址、返回
    SELECT inout_param;     # 传址、可读、返回

    -- 修改参数的值
    SET in_param = 100;
    SET out_param = 200;
    SET inout_param = 300;
END ;

-- 声明变量
SET @in_value = 10;
SET @out_value = 20;
SET @inout_value = 30;

-- 调用存储过程
CALL ParameterExample(@in_value, @out_value, @inout_value);

-- 打印
SELECT @in_value, @out_value, @inout_value;

-- 删除
drop procedure if exists ParameterExample;
```

### 4. 判断语句
```
## if语句
# if condition_1 then
#     ...
# elseif condition_2 then
#     ...
# else
#     ...
# end if;

CREATE PROCEDURE example_procedure()
BEGIN
    DECLARE f1 INT;
    DECLARE f2 INT;
    DECLARE f3 INT;
    DECLARE temp INT;
    SET f1 := 3;
    SET f2 := 2;
    SET f3 := 1;
    SELECT f1,f2,f3;
    if f1 < f2 then
        temp := f1;
        f1 := f2;
        f2 := temp;
    elseif f1 > f2 then
        select 'f1';
    else
        select 'f3';
    end if;
END ;


## case语句
# case
#     when ... then ...;
#     [when ... then ...;]
#     [else ...;]
# end case;

create procedure p(
    in score int,
    out res varchar(20)
)
begin
    # 使用case进行条件判断
    case
        when score>=90 and score<=100
            then set res := '优秀';
        when score>=80 and score<90
            then set res := '良好';
        when score>=60 and score<80
            then set res := '一般';
        when score>=0 and score<60
            then set res := '不及格';
        # 若以上条件都不满足，则返回else后面的语句
        else set res := '输入不合法';
    end case;
end ;

-- 自定义变量
set @score := 1000;
set @res := '';

-- 查看
show create procedure p;

-- 调用函数
call p(@score,@res);

-- 返回结果
select @score,@res;
```

### 5. 循环 
```
## while do
# while ... do
#     ...;
# end while;

create procedure count_num(
    in num int,
    out sum int
    )
begin
    declare i int default 1;
    while i <= 10 do
        set sum := sum+i;
        set i := i+1;
    end while;
    select i,sum;
end ;

set @num = 10;
set @sum = 0;

call count_num(@num,@sum);

drop procedure count_num;

select @num,@sum;


## repeat 循环
# repeat
#     ...;
# until ...  # 直到满足条件退出
# end repeat;

create procedure count_num(
    in num int,
    out sum int
    )
begin
    declare i int default 1;
    repeat
        set sum := sum+i;
        set i := i+1;
    until i > 10  # 直到满足条件退出
    end repeat;
    select num,i,sum;
end ;


## loop 循环
lable_name: loop
    ...;
end loop lable_name;

create procedure count_num(in n int)
begin
    declare sum int default 0;
    
    sum:loop
        if n<=0 then
            leave sum;
        end if;
        
        set sum := sum + n;
        set n := n - 1;
    end loop sum;
    
    select total;
end ;

leave label_name;  # 退出循环  break
iterate label_name;  # 跳过下一次循环  continue
```

### 6. 递归
```
-- 递归阶乘
CREATE PROCEDURE calculate_factorial(
    IN n INT,
    OUT result BIGINT
)
BEGIN
    IF n <= 1 THEN
        SET result = 1;
    ELSE
        CALL calculate_factorial(n - 1, result);
        SET result = n * result;
    END IF;
END ;

-- 设置变量
SET @input = 5;
SET @output = 1;

-- 修改递归深度，系统变量
SET @@max_sp_recursion_depth = @input;
select @@max_sp_recursion_depth;

CALL calculate_factorial(@input, @output);
SELECT @input, @output;

DROP PROCEDURE IF EXISTS calculate_factorial;
```

### 7. cursor 游标
```
# 创建游标
declare cur_name cursor for 查询语句;

# 开启游标
open cur_name;

# 获取游标数据
fetch cur_name into var1[,var2...];  -- 一次只获取一条数据

# 关闭游标
close cur_name;
```

### 8. handler 条件处理程序
```
DECLARE handler_action HANDLER FOR condition_value statement;

# 活动控制
handler_action:
    continue
    exit

# 状态码
condition_value:
    sqlstate sqlstate_value: 指定捕获状态码，'02000'捕获空数据,状态码需要引号括起
    sqlwarning: 捕获'01'开头的状态码
    not found: 捕获'02'开头的状态码
    sqlexception: 捕获除了'01', '02'之外的状态码
    
# 执行语句
statement


create procedure p(in n int)
begin
    declare cname varchar(20);
    declare cage int;
    -- 游标
    declare cur_exl cursor for select name,age from excel_table where age<n;
    -- 条件处理程序
    declare exit handler for sqlstate '02000' close cur_exl;

    drop table if exists cur_exl_tab;
    create table if not exists cur_exl_tab(
        id int primary key auto_increment,
        name varchar(20),
        age int
    );

    open cur_exl;
    while true do
        fetch cur_exl into cname,cage;
        insert into cur_exl_tab values (null,cname,cage);
    end while ;
end ;

call p(30);
drop procedure p;
```

### 9. 存储函数  参数列表是in类型的
```
create function function_name([lists])
returns type [characterstic]
begin
    ...;
    return...;
end;

characterstic:
    deterministic: 确定性函数 相同的输入，相同的输出
    no sql: 不含sql语句
    reads sql data: 包含读数据语句，不包含写数据语句

create function fun1(n int)
returns int deterministic  # 指定返回类型
begin
    declare res int default 0;

    while n>=0 do
        set res := res+n;
        set n := n-1;
    end while;

    return res;  # 返回参数
end ;

select fun1(20);
```
