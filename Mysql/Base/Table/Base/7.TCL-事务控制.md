## TCL - 事务控制
```
TCL（Transaction Control Language）事务控制语言
事务相关：提交、回滚、设置保存点。
常见语句：
START TRANSACTION / BEGIN
COMMIT
ROLLBACK
SAVEPOINT / ROLLBACK TO SAVEPOINT
```

### 1. 理论知识
```
# 事务操作只对DML管用，
而DDL(CREATE\ALTER\DROP\TRUNCATE)、DCL大部分命令都是隐性提交，或者直接对系统表生效，无法手动提交事务，
DQL不改数据，并且由于事务的隔离性，DQL没什么意义，且会出现事务并发问题

# 会话
SELECT CONNECTION_ID();         # 查看当前会话id
SHOW PROCESSLIST;               # 查询会话连接表
# 查看正在运行线程
SELECT *
FROM information_schema.innodb_trx
WHERE trx_mysql_thread_id = CONNECTION_ID();
# 一个用户可以同时拥有多个会话
在mysql中一个用户可以同时建立多个会话，即开两个终端各种执行一次登录，就能获得两个相互隔离的会话
mysql -h 127.0.0.1 -P 3306 -u your_user -p your_db
@@autocommit=1;自动提交事务，即每条sql语句都相当于是一个事务

# 事务的四大特性
原子性：不可分割，要么成功，要么失败      # 事务可以用于脚本、一次性任务
一致性：事务完成，则数据状态一致
隔离性：隔离机制，保证事务操作独立       # 多任务并行需要用锁来控制
持久性：提交回滚，对数据永久改变        # 事务一旦提交就无法回滚

# 
```

### 2. 事务流程
```
开启事务 → 执行成功 → COMMIT：更改对其他会话可见，并且持久化，即无法回滚
开启事务 → 执行失败/主动取消 → ROLLBACK：撤销本事务内的更改，数据库回到事务开始/保存点前的状态
事务流程：
    开启事务
    [设置保存点]
    [异常 回滚事务到开始/保存点]
    提交事务

# 查看事务提交方式
select @@autocommit;    # 0表示手动提交，1表示自动提交
# 设置事务提交方式为手动提交
set @@autocommit=0;

# 开启事务
start transaction/begin;

# 设置保存点
savepoint sp1;          # 设置sp1保存点
rollback to sp1;        # 之回滚到sp1保存点之前

# 回滚事务
rollback;

# 提交事务
commit;
```

### 3. 并发处理
```
# 并发事务读取问题
脏读：一个事务读到另一个事务还没提交数据
不可重复读：一个事务读取同一条记录，但两次读取的数据不同
幻读：一个事务按照条件查询数据时，没有对应的数据行，但在插入数据时，又发现数据行存在

# 注意这是并发事务中可能出现的问题，而不是隔离级别的本质，
脏读（Dirty Read）：事务A读到了事务B未提交的数据；如果B回滚，A读到的就是“脏的”，读到不存在在的数据
不可重复读（Non-repeatable Read）：事务A在同一事务中两次读 同一行，中间被事务B提交了UPDATE/DELETE，导致两次结果不同。
幻读（Phantom Read）：事务A在同一事务中两次按同一条件查询一批行（范围），中间事务B提交了INSERT/DELETE（影响该范围），导致第二次“多了/少了行”。

# 隔离级别              脏读   不可重复读   幻读         简述
read uncommitted        1         1         1        # 读未提交
read committed          0         1         1        # 读已提交
repeatable read         0         0         1        # 可重复读(默认),读取
serializable            0         0         0        # 串行化

## 隔离级别的本质
read uncommitted->每次读取都是构建一个未提交事务+数据库的快照，即能够读取到未提交事务的dml
read committed->每次读取都是构建一个当前数据库的快照，即读取已提交的事务->当前数据库的快照
repeatable read->开启事务时构建一个当前数据库的快照，不论其他事务如何dml都不影响在该事务中快照
serializable->构建一个当前数据库的快照，且所有查询语句都会加共享锁（S-lock），堵塞、强制串行

# 查看隔离级别
select @@transacition_isolation;

# 设置事务隔离级别
set [session/global] transaction isolation level 隔离级别;
```
