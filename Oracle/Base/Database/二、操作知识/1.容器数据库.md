# 容器数据库

## 一、创建容器数据库CDB

### 1. 配置初始化文件
```
# 配置临时环境变量
export ORACLE_SID=test
export ORACLE_BASE=/var/lib/docker/volumes/oracle_opt/_data/oracle
export ORACLE_HOME=$ORACLE_BASE/product/19c/dbhome_1
export PATH=$PATH:$ORACLE_HOME/bin

# 创建相关目录
mkdir -p $ORACLE_BASE/admin/$ORACLE_SID/{a,b,c,u}dump
mkdir -p $ORACLE_BASE/admin/$ORACLE_SID/pfile
mkdir -p $ORACLE_BASE/oradata/$ORACLE_SID

# 配置初始化文件
cp $ORACLE_HOME/dbs/init.ora $ORACLE_HOME/dbs/inittest.ora
vi $ORACLE_HOME/dbs/inittest.ora

# 注意修改数据库名称，以及将<ORACLE_BASE>改为绝对路径
db_name='test'
memory_target=1G
processes = 150
audit_file_dest='/var/lib/docker/volumes/oracle_opt/_data/oracle/admin/test/adump'audit_trail ='db'
db_block_size=8192
db_domain=''
db_recovery_file_dest='/var/lib/docker/volumes/oracle_opt/_data/oracle/fast_recovery_area'
db_recovery_file_dest_size=2G
diagnostic_dest='/var/lib/docker/volumes/oracle_opt/_data/oracle'
dispatchers='(PROTOCOL=TCP) (SERVICE=ORCLXDB)'
open_cursors=300
remote_login_passwordfile='EXCLUSIVE'
undo_tablespace='UNDOTBS1'
# You may want to ensure that control files are created on separate physical
# devices
control_files = (ora_control1, ora_control2)
compatible ='11.2.0'
```

### 2.编写创建CDB脚本
```
# 编写创建数据库脚本 
vim $ORACLE_BASE/oradata/$ORACLE_SID/script.sql

-- 创建数据库
CREATE DATABASE test
CONTROLFILE REUSE
MAXDATAFILES 100
MAXINSTANCES 6
MAXLOGFILES 20
MAXLOGHISTORY 20
MAXLOGMEMBERS 3
-- 设置默认字符集以及国家字符集
CHARACTER SET AL32UTF8
NATIONAL CHARACTER SET AL16UTF16
-- 创建日志组组员
LOGFILE 
GROUP 1 ('/opt/oracle/oradata/test/redo01.log','/opt/oracle/oradata/test/redo02.log','/opt/oracle/oradata/test/redo03.log') SIZE 30M REUSE,
GROUP 2 ('/opt/oracle/oradata/test/redo04.log','/opt/oracle/oradata/test/redo05.log','/opt/oracle/oradata/test/redo06.log') SIZE 30M REUSE
-- 创建系统表空间
DATAFILE '/opt/oracle/oradata/test/system01.dbf' SIZE 100M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE UNLIMITED EXTENT MANAGEMENT LOCAL
-- 创建辅助表空间
SYSAUX DATAFILE '/opt/oracle/oradata/test/sysaux01.dbf' SIZE 100M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE UNLIMITED
-- 创建回滚表空间
UNDO TABLESPACE UNDOTBS1 DATAFILE '/opt/oracle/oradata/test/undotbs01.dbf' SIZE 20M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE UNLIMITED
-- 创建默认临时表空间
DEFAULT TEMPORARY TABLESPACE TEMP TEMPFILE '/opt/oracle/oradata/test/temp01.dbf' SIZE 20M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE UNLIMITED;


# 参数解释：
CONTROLFILE REUSE       覆盖已存在数据库
MAXDATAFILES 100        最大数据文件数目
MAXINSTANCES 2          最大并发实例数目
MAXLOGFILES 20          最大日志文件数目
MAXLOGHISTORY 20        最大历史日志数目
MAXLOGMEMBERS 3         最大日志组员数目
```

### 3. 执行脚本
```
# 进入容器，sysdba登录
docker exec -it oracle bash
sqlplus / as sysdba

# NOMOUNT 启用数据库
SHUTDOWN IMMEDIATE;
STARTUP NOMOUNT PFILE='/opt/oracle/product/19c/dbhome_1/dbs/inittest.ora';

# 查看
SHOW PARAMETER MEMORY_TARGET;
SHOW PARAMETER MEMORY_MAX_TARGET;

# 修改新数据库共享内存与最大内存
ALTER SYSTEM SET MEMORY_TARGET = 3G SCOPE=SPFILE;
ALTER SYSTEM SET MEMORY_MAX_TARGET = 4G SCOPE=SPFILE;

# 执行脚本
@/opt/oracle/oradata/test/script.sql
```

### 3. 其他配置
```
# 参数和配置管理
SHOW PARAMETER;                             查看初始化参数
SHOW PARAMETER parameter_name;              查看特定参数
ALTER SYSTEM SET parameter_name=value SCOPE=SPFILE; 修改初始化参数（在 SPFILE 中）

# 数据库备份与恢复
RMAN> BACKUP DATABASE;                      创建备份（使用 RMAN）
RMAN> RESTORE DATABASE;                     恢复数据库（使用 RMAN）

# 用户和权限管理
CREATE USER username IDENTIFIED BY password;创建用户
GRANT role TO username;                     授予权限
REVOKE role FROM username;                  撤销权限

# 数据库对象管理
CREATE TABLESPACE tablespace_name DATAFILE '/path/to/file.dbf' SIZE 100M;   创建表空间
CREATE TABLE table_name (column1 datatype, column2 datatype);               创建表
INSERT INTO table_name (column1, column2) VALUES (value1, value2);          插入数据
SELECT * FROM table_name;                                                   查询数据

# 监控和性能
SELECT * FROM v$session;                    查看会话信息
SELECT * FROM v$lock;                       查看锁定情况
```